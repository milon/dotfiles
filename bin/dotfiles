#!/bin/zsh

# Constants
readonly BIN_NAME=$(basename "$0")
readonly ARROW="âžœ"
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly NC='\033[0m'

# Load config
export bin_dir=$(dirname "$(realpath "$0")")
export dotfiles_dir=$(dirname "$bin_dir")
export support_dir="$dotfiles_dir/support"

# Load functions
source "$support_dir/functions.sh"

# Command to script mapping
declare -A COMMAND_SCRIPTS
COMMAND_SCRIPTS=(
    [symlinks]="sym_links.sh"
    [brew]="brew.sh"
    [node]="node.sh"
    [python]="python.sh"
    [java]="java.sh"
    [ruby]="ruby.sh"
    [composer]="composer.sh"
    [valet]="valet.sh"
    [git]="git.sh"
    [clone]="git_clone.sh"
    [pull]="pull.sh"
    [mac]="mac_settings.sh"
    [xcode]="xcode.sh"
)

# Run a support script
run_script() {
    local script_name=$1
    local success_message=$2
    
    source "$support_dir/$script_name"
    
    if [ -n "$success_message" ]; then
        echo -e "${GREEN}${ARROW} ${success_message}${NC}"
    fi
}

# Show help message
show_help() {
    ascii_art
    echo
    echo -e "${ARROW} Usage: ${YELLOW}${BIN_NAME} <command>${NC}"
    echo
    echo "${GREEN}Commands:${NC}"
    echo "   ${YELLOW}help${NC}             This help message"
    echo "   ${YELLOW}update${NC}           Update packages and pkg managers (brew, mac app store, composer)"
    echo "   ${YELLOW}clean${NC}            Clean up caches (brew, npm, composer)"
    echo "   ${YELLOW}symlinks${NC}         Run symlinks script"
    echo "   ${YELLOW}brew${NC}             Run brew script"
    echo "   ${YELLOW}node${NC}             Run node setup script"
    echo "   ${YELLOW}python${NC}           Run python setup script"
    echo "   ${YELLOW}java${NC}             Run java setup script"
    echo "   ${YELLOW}ruby${NC}             Run ruby setup script"
    echo "   ${YELLOW}composer${NC}         Run composer setup script"
    echo "   ${YELLOW}valet${NC}            Run valet script"
    echo "   ${YELLOW}git${NC}              Run git config script"
    echo "   ${YELLOW}clone${NC}            Run git clone script"
    echo "   ${YELLOW}pull${NC}             Run git pull script to update all repos"
    echo "   ${YELLOW}mac${NC}              Run MacOS defaults script"
    echo "   ${YELLOW}xcode${NC}            Run XCode script"
    echo "   ${YELLOW}vim${NC}              Run vim script"
    echo "   ${YELLOW}neovim${NC}           Run neovim script"
    echo
}

# Update packages
cmd_update() {
    echo "Update brew"
    brew cu --all --include-mas --yes --cleanup
    brew upgrade
    
    echo ""
    echo "Update composer and its global dependencies"
    composer self-update && composer global update
    
    echo ""
    echo -e "${GREEN}${ARROW} Success! Update command finished.${NC}"
}

# Clean caches
cmd_clean() {
    brew cleanup
    npm cache clean --force
    composer clear-cache
    echo -e "${GREEN}${ARROW} Success! Clean command finished.${NC}"
}

# Vim setup (requires dependencies)
cmd_vim() {
    run_script "dependencies.sh"
    run_script "vim.sh" "Success! Vim command finished."
}

# Neovim setup (requires dependencies)
cmd_neovim() {
    run_script "dependencies.sh"
    run_script "neovim.sh" "Success! Neovim command finished."
}

# Main command dispatcher
main() {
    local command_name=$1
    
    # Handle help
    if [[ -z "$command_name" || "$command_name" == "-h" || "$command_name" == "--help" ]]; then
        show_help
        exit 0
    fi
    
    # Handle special commands
    case "$command_name" in
        update)
            cmd_update
            ;;
        clean)
            cmd_clean
            ;;
        vim)
            cmd_vim
            ;;
        neovim)
            cmd_neovim
            ;;
        *)
            # Handle mapped commands
            if [[ -n "${COMMAND_SCRIPTS[$command_name]}" ]]; then
                local script="${COMMAND_SCRIPTS[$command_name]}"
                local success_msg="Success! $(echo "$command_name" | sed 's/^./\U&/') command finished."
                run_script "$script" "$success_msg"
            else
                echo -e "${RED}${ARROW} Error: '${command_name}' is not a known command.${NC}" >&2
                show_help
                exit 1
            fi
            ;;
    esac
}

# Run main function
main "$@"
