#!/bin/zsh

# Constants
readonly BIN_NAME=$(basename "$0")

# Load config
export bin_dir=$(dirname "$(realpath "$0")")
export dotfiles_dir=$(dirname "$bin_dir")
export support_dir="$dotfiles_dir/support"

# Load functions (includes color constants and output helpers)
source "$support_dir/functions.sh"

# Command to script mapping
declare -A COMMAND_SCRIPTS
COMMAND_SCRIPTS=(
    [symlinks]="sym_links.sh"
    [brew]="brew.sh"
    [node]="node.sh"
    [python]="python.sh"
    [java]="java.sh"
    [ruby]="ruby.sh"
    [php]="php.sh"
    [rust]="rust.sh"
    [valet]="valet.sh"
    [git]="git.sh"
    [clone]="git_clone.sh"
    [pull]="pull.sh"
    [mac]="mac_settings.sh"
    [xcode]="xcode.sh"
    [vim]="vim.sh"
    [neovim]="neovim.sh"
)

# Run a support script
run_script() {
    local script_name=$1
    local display_name=${2:-$script_name}
    shift 2 2>/dev/null
    local script_path="$support_dir/$script_name"
    
    if [ ! -f "$script_path" ]; then
        print_error "Script not found: ${script_name}"
        return 1
    fi
    
    print_section "Running ${display_name}"
    # Set script arguments before sourcing so they're available as $1, $2, etc.
    set -- "$@"
    source "$script_path"
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        echo
        print_success "${display_name} completed successfully"
    else
        echo
        print_error "${display_name} failed (exit code: ${exit_code})"
        return $exit_code
    fi
}

# Show help message
show_help() {
    ascii_art
    echo
    echo -e "${BOLD}${CYAN}${ARROW} Usage: ${YELLOW}${BIN_NAME} <command>${NC}"
    echo
    echo -e "${BOLD}${GREEN}Commands:${NC}"
    echo
    echo -e "  ${YELLOW}help${NC}             ${CYAN}Show this help message${NC}"
    echo -e "  ${YELLOW}update${NC}           ${CYAN}Update packages and pkg managers (brew, mac app store, composer)${NC}"
    echo -e "  ${YELLOW}clean${NC}            ${CYAN}Clean up caches (brew, npm, composer)${NC}"
    echo
    echo -e "  ${BOLD}Setup:${NC}"
    echo -e "  ${YELLOW}symlinks${NC}         ${CYAN}Create symlinks for dotfiles${NC}"
    echo -e "  ${YELLOW}brew${NC}             ${CYAN}Install Homebrew and dependencies${NC}"
    echo -e "  ${YELLOW}git${NC}              ${CYAN}Configure git settings${NC}"
    echo
    echo -e "  ${BOLD}Languages:${NC}"
    echo -e "  ${YELLOW}php${NC}              ${CYAN}Setup PHP and Composer${NC}"
    echo -e "  ${YELLOW}node${NC}             ${CYAN}Setup Node.js environment${NC}"
    echo -e "  ${YELLOW}python${NC}           ${CYAN}Setup Python environment${NC}"
    echo -e "  ${YELLOW}java${NC}             ${CYAN}Setup Java environment${NC}"
    echo -e "  ${YELLOW}ruby${NC}             ${CYAN}Setup Ruby environment${NC}"
    echo -e "  ${YELLOW}rust${NC}             ${CYAN}Setup Rust environment${NC}"
    echo
    echo -e "  ${BOLD}Development:${NC}"
    echo -e "  ${YELLOW}valet${NC}            ${CYAN}Setup Laravel Valet${NC}"
    echo -e "  ${YELLOW}clone${NC}            ${CYAN}Clone git repositories${NC}"
    echo -e "  ${YELLOW}pull${NC}             ${CYAN}Update all git repositories${NC}"
    echo
    echo -e "  ${BOLD}Editors:${NC}"
    echo -e "  ${YELLOW}vim${NC}              ${CYAN}Setup Vim${NC}"
    echo -e "  ${YELLOW}neovim${NC}           ${CYAN}Setup Neovim${NC}"
    echo
    echo -e "  ${BOLD}System:${NC}"
    echo -e "  ${YELLOW}mac${NC}              ${CYAN}Configure macOS settings${NC}"
    echo -e "  ${YELLOW}xcode${NC}            ${CYAN}Setup Xcode${NC}"
    echo
}

# Update packages
cmd_update() {
    print_section "Updating Packages"
    
    print_step "Updating Homebrew and Mac App Store apps..."
    if brew cu --all --include-mas --yes --cleanup 2>/dev/null; then
        print_success "Homebrew casks updated"
    else
        print_info "brew-cask-upgrade not available, skipping cask updates"
    fi
    
    print_step "Upgrading Homebrew packages..."
    if brew upgrade; then
        print_success "Homebrew packages upgraded"
    else
        print_error "Some Homebrew packages failed to upgrade"
    fi
    
    echo
    print_step "Updating Composer and global dependencies..."
    if composer self-update && composer global update; then
        print_success "Composer updated"
    else
        print_error "Composer update failed"
    fi
    
    echo
    print_success "All packages updated successfully"
}

# Clean caches
cmd_clean() {
    print_section "Cleaning Caches"
    
    print_step "Cleaning Homebrew cache..."
    if brew cleanup; then
        print_success "Homebrew cache cleaned"
    fi
    
    print_step "Cleaning npm cache..."
    if npm cache clean --force 2>/dev/null; then
        print_success "npm cache cleaned"
    else
        print_info "npm not available, skipping"
    fi
    
    print_step "Cleaning Composer cache..."
    if composer clear-cache 2>/dev/null; then
        print_success "Composer cache cleaned"
    else
        print_info "Composer not available, skipping"
    fi
    
    echo
    print_success "Cache cleanup completed"
}

# Main command dispatcher
main() {
    local command_name=$1
    
    # Handle help
    if [[ -z "$command_name" || "$command_name" == "-h" || "$command_name" == "--help" ]]; then
        show_help
        exit 0
    fi
    
    # Handle special commands that don't map to scripts
    case "$command_name" in
        help)
            show_help
            ;;
        update)
            cmd_update
            ;;
        clean)
            cmd_clean
            ;;
        *)
            # Handle mapped commands (all scripts)
            if [[ -n "${COMMAND_SCRIPTS[$command_name]}" ]]; then
                local script="${COMMAND_SCRIPTS[$command_name]}"
                # Capitalize first letter for display using zsh parameter expansion
                local first_char="${command_name[1]}"
                local rest="${command_name[2,-1]}"
                local display_name="${(U)first_char}${rest}"
                shift  # Remove command_name from arguments
                run_script "$script" "$display_name" "$@"
            else
                print_error "Unknown command: '${command_name}'"
                echo
                show_help
                exit 1
            fi
            ;;
    esac
}

# Run main function
main "$@"
